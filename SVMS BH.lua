-- [[
--  * Seventyn Multi SC
--  * VERSION : 1.2 
--  * LAUNCHER : BOTHAX
--  * SERVER : GTFY
--  * Cr @Svntyn ⃤
-- ]]

--[[
 /¯¯¯/¯¯\‚     ‚'            /¯¯/¯¯|          /¯¯¯/¯¯'\ "  /¯¯¯/¯¯\‚     ‚'  
|¯¯¯|  |\_/       °/¯¯¯/¯¯\¯|    |   /¯¯¯/¯¯\|       \  |¯¯¯|  |\_/       °
\¯¯¯\  ``¯¯¯¯\  \¯¯¯\     \ |    |  \¯¯¯\     __|\_./  \¯¯¯\  ``¯¯¯¯\  
  ¯¯¯)¯¯¯)    /    \     \     \|    |    \     '\   '\‚        '   ¯¯¯)¯¯¯)    /  
       |___'|__/'      \__\'____ / ''    \__ \_/’                 |___'|__/'  
              "                           ‚                ’                         "        
--]]
--[[
 /¯¯¯/¯¯\‚     ‚'            /¯¯/¯¯|          /¯¯¯/¯¯'\ "  /¯¯¯/¯¯\‚     ‚'  
|¯¯¯|  |\_/       °/¯¯¯/¯¯\¯|    |   /¯¯¯/¯¯\|       \  |¯¯¯|  |\_/       °
\¯¯¯\  ``¯¯¯¯\  \¯¯¯\     \ |    |  \¯¯¯\     __|\_./  \¯¯¯\  ``¯¯¯¯\  
  ¯¯¯)¯¯¯)    /    \     \     \|    |    \     '\   '\‚        '   ¯¯¯)¯¯¯)    /  
       |___'|__/'      \__\'____ / ''    \__ \_/’                 |___'|__/'  
              "                           ‚                ’                         "        
--]]
--[[
 /¯¯¯/¯¯\‚     ‚'            /¯¯/¯¯|          /¯¯¯/¯¯'\ "  /¯¯¯/¯¯\‚     ‚'  
|¯¯¯|  |\_/       °/¯¯¯/¯¯\¯|    |   /¯¯¯/¯¯\|       \  |¯¯¯|  |\_/       °
\¯¯¯\  ``¯¯¯¯\  \¯¯¯\     \ |    |  \¯¯¯\     __|\_./  \¯¯¯\  ``¯¯¯¯\  
  ¯¯¯)¯¯¯)    /    \     \     \|    |    \     '\   '\‚        '   ¯¯¯)¯¯¯)    /  
       |___'|__/'      \__\'____ / ''    \__ \_/’                 |___'|__/'  
              "                           ‚                ’                         "        
--]]
--[[
 /¯¯¯/¯¯\‚     ‚'            /¯¯/¯¯|          /¯¯¯/¯¯'\ "  /¯¯¯/¯¯\‚     ‚'  
|¯¯¯|  |\_/       °/¯¯¯/¯¯\¯|    |   /¯¯¯/¯¯\|       \  |¯¯¯|  |\_/       °
\¯¯¯\  ``¯¯¯¯\  \¯¯¯\     \ |    |  \¯¯¯\     __|\_./  \¯¯¯\  ``¯¯¯¯\  
  ¯¯¯)¯¯¯)    /    \     \     \|    |    \     '\   '\‚        '   ¯¯¯)¯¯¯)    /  
       |___'|__/'      \__\'____ / ''    \__ \_/’                 |___'|__/'  
              "                           ‚                ’                         "        
--]]
--[[
 /¯¯¯/¯¯\‚     ‚'            /¯¯/¯¯|          /¯¯¯/¯¯'\ "  /¯¯¯/¯¯\‚     ‚'  
|¯¯¯|  |\_/       °/¯¯¯/¯¯\¯|    |   /¯¯¯/¯¯\|       \  |¯¯¯|  |\_/       °
\¯¯¯\  ``¯¯¯¯\  \¯¯¯\     \ |    |  \¯¯¯\     __|\_./  \¯¯¯\  ``¯¯¯¯\  
  ¯¯¯)¯¯¯)    /    \     \     \|    |    \     '\   '\‚        '   ¯¯¯)¯¯¯)    /  
       |___'|__/'      \__\'____ / ''    \__ \_/’                 |___'|__/'  
              "                           ‚                ’                         "        
--]]
--[[
 /¯¯¯/¯¯\‚     ‚'            /¯¯/¯¯|          /¯¯¯/¯¯'\ "  /¯¯¯/¯¯\‚     ‚'  
|¯¯¯|  |\_/       °/¯¯¯/¯¯\¯|    |   /¯¯¯/¯¯\|       \  |¯¯¯|  |\_/       °
\¯¯¯\  ``¯¯¯¯\  \¯¯¯\     \ |    |  \¯¯¯\     __|\_./  \¯¯¯\  ``¯¯¯¯\  
  ¯¯¯)¯¯¯)    /    \     \     \|    |    \     '\   '\‚        '   ¯¯¯)¯¯¯)    /  
       |___'|__/'      \__\'____ / ''    \__ \_/’                 |___'|__/'  
              "                           ‚                ’                         "        
--]]
--[[
 /¯¯¯/¯¯\‚     ‚'            /¯¯/¯¯|          /¯¯¯/¯¯'\ "  /¯¯¯/¯¯\‚     ‚'  
|¯¯¯|  |\_/       °/¯¯¯/¯¯\¯|    |   /¯¯¯/¯¯\|       \  |¯¯¯|  |\_/       °
\¯¯¯\  ``¯¯¯¯\  \¯¯¯\     \ |    |  \¯¯¯\     __|\_./  \¯¯¯\  ``¯¯¯¯\  
  ¯¯¯)¯¯¯)    /    \     \     \|    |    \     '\   '\‚        '   ¯¯¯)¯¯¯)    /  
       |___'|__/'      \__\'____ / ''    \__ \_/’                 |___'|__/'  
              "                           ‚                ’                         "        
--]]
--[[
 /¯¯¯/¯¯\‚     ‚'            /¯¯/¯¯|          /¯¯¯/¯¯'\ "  /¯¯¯/¯¯\‚     ‚'  
|¯¯¯|  |\_/       °/¯¯¯/¯¯\¯|    |   /¯¯¯/¯¯\|       \  |¯¯¯|  |\_/       °
\¯¯¯\  ``¯¯¯¯\  \¯¯¯\     \ |    |  \¯¯¯\     __|\_./  \¯¯¯\  ``¯¯¯¯\  
  ¯¯¯)¯¯¯)    /    \     \     \|    |    \     '\   '\‚        '   ¯¯¯)¯¯¯)    /  
       |___'|__/'      \__\'____ / ''    \__ \_/’                 |___'|__/'  
              "                           ‚                ’                         "        
--]]
--[[
 /¯¯¯/¯¯\‚     ‚'            /¯¯/¯¯|          /¯¯¯/¯¯'\ "  /¯¯¯/¯¯\‚     ‚'  
|¯¯¯|  |\_/       °/¯¯¯/¯¯\¯|    |   /¯¯¯/¯¯\|       \  |¯¯¯|  |\_/       °
\¯¯¯\  ``¯¯¯¯\  \¯¯¯\     \ |    |  \¯¯¯\     __|\_./  \¯¯¯\  ``¯¯¯¯\  
  ¯¯¯)¯¯¯)    /    \     \     \|    |    \     '\   '\‚        '   ¯¯¯)¯¯¯)    /  
       |___'|__/'      \__\'____ / ''    \__ \_/’                 |___'|__/'  
              "                           ‚                ’                         "        
--]]









































































































































-- CONFIG --
local Booth = {
  running = false,
  delay = 80 
}
local MIRRORMAZE = {
    running = false,
    doorX   = 26,
    doorY   = 22,
    targetX = 24,
    targetY = 24,
    delay   = 1000,
    state = 0 -- 0: idle, 1: going to door, 2: entering, 3: going to target
}
local Shop  = {
  running = false,
  delay = 100, -- Delay between buy attempts
  itemid = 1796
}
local UT  = {
  running = false,
  delay = 100, -- Delay between remove and drop
  tilex = 4,
  tiley = 48,
  removeItem = 200,
  dropItem = 16956,
  dropCount = 200
}
local PNB   = {
  running = false,
  delay = 100, -- Delay between place/break actions
  itemid = 17092,
  maxBlocks = 10,
  currentBlock = 1, -- Track current block for non-blocking operation
  state = 0 -- 0: idle, 1: placing, 2: breaking
}
local VENDING = {
    running   = false,
    shopWorld = "nice",
    dropWorld = "svms",
    itemid    = 3207,
    buycount  = 200,
    tilex     = 10,
    tiley     = 46,
    dropx     = 10,
    dropy     = 46,
    state = 0 -- 0: idle, 1: joining shop world, 2: buying, 3: joining drop world, 4: dropping
}
local ADDVEND = {
    running = false,
    tilex   = 48,
    tiley   = 36,
    price   = 1,
    perlock = 0,
    peritem = 1,
    delay = 1000 -- Delay between add stock attempts
}
local PLANT = {
    running   = false,
    seedid   = 17093,
    TakeSeed_X = 11,
    TakeSeed_Y = 44,
    X_MIN = 1,
    X_MAX = 98,
    Y_MIN = 0,
    Y_MAX = 20,
    currentX = 0, -- Track current position for non-blocking operation
    currentY = 0,
    lastPlantTime = 0, -- For rate limiting
    plantDelay = 300, -- Delay between planting actions
    logInterval = 10 -- Log every N tiles planted
}

-- ===================== HELPER FUNCTIONS =====================
local function logState(name, state)
    local status = state and "`2ON" or "`4OFF"
    LogToConsole("[SVMS] "..name.." -> "..status)
end

local function logMessage(msg)
    SendVariantList({[0] = "OnTextOverlay", [1] = "`c[ SVMS ] : " .. msg})
    LogToConsole("`c[ SVMS ] : " .. msg)
end

local function plant_pnp(x, y, id)
    local me = GetLocal()
    if not me then return end
    local pkt = {type = 3, value = id, x = me.pos.x, y = me.pos.y, px = x, py = y}
    SendPacketRaw(false , pkt)
end

local function GetItemCount(itemID)
    local inventory = GetInventory()
    for _, item in pairs(inventory) do
        if item.id == itemID then
            return item.amount
        end
    end
    return 0
end

-- ===================== MAIN LOOP (Optimized) =====================
-- Menggabungkan semua logika fitur ke dalam satu thread utama
RunThread(function()
    PLANT.currentX = PLANT.X_MIN
    PLANT.currentY = PLANT.Y_MIN

    while true do
        local currentTime = os.clock() * 1000 -- Get current time in milliseconds

        -- VENDING State Machine
        if VENDING.running then
            local currentWorld = GetWorld().name
            if VENDING.state == 0 then -- Initial state, join shop world
                logMessage("Vending: Joining shop world '" .. VENDING.shopWorld .. "'")
                SendPacket(3, "action|join_request\nname|" .. VENDING.shopWorld .. "\ninvitedWorld|0")
                VENDING.state = 1
                Sleep(1500) -- Give time to join world
            elseif VENDING.state == 1 then -- Waiting in shop world
                if currentWorld == VENDING.shopWorld then
                    logMessage("Vending: Moving to vending machine at (" .. VENDING.tilex .. "," .. VENDING.tiley .. ")")
                    FindPath(VENDING.tilex, VENDING.tiley)
                    VENDING.state = 2
                    Sleep(1000) -- Give time to pathfind
                else
                    -- Still waiting to join, or joined wrong world, retry
                    logMessage("Vending: Still waiting to join shop world. Retrying...")
                    SendPacket(3, "action|join_request\nname|" .. VENDING.shopWorld .. "\ninvitedWorld|0")
                    Sleep(1500)
                end
            elseif VENDING.state == 2 then -- Buying item
                logMessage("Vending: Buying " .. VENDING.buycount .. " of item " .. VENDING.itemid)
                local pktBuy = "action|dialog_return\n" ..
                               "dialog_name|vending\n" ..
                               "tilex|"..VENDING.tilex.."|\n" ..
                               "tiley|"..VENDING.tiley.."|\n" ..
                               "expectprice|1|\n" ..
                               "expectitem|"..VENDING.itemid.."|\n" ..
                               "verify|1|\n"..
                               "buycount|"..VENDING.buycount
                SendPacket(2, pktBuy)
                VENDING.state = 3
                Sleep(500) -- Short delay after sending packet
            elseif VENDING.state == 3 then -- Joining drop world
                logMessage("Vending: Joining drop world '" .. VENDING.dropWorld .. "'")
                SendPacket(3, "action|join_request\nname|" .. VENDING.dropWorld .. "\ninvitedWorld|0")
                VENDING.state = 4
                Sleep(1500) -- Give time to join world
            elseif VENDING.state == 4 then -- Waiting in drop world
                if currentWorld == VENDING.dropWorld then
                    logMessage("Vending: Moving to drop location at (" .. VENDING.dropx .. "," .. VENDING.dropy .. ")")
                    FindPath(VENDING.dropx, VENDING.dropy)
                    VENDING.state = 5
                    Sleep(1000) -- Give time to pathfind
                else
                    -- Still waiting to join, or joined wrong world, retry
                    logMessage("Vending: Still waiting to join drop world. Retrying...")
                    SendPacket(3, "action|join_request\nname|" .. VENDING.dropWorld .. "\ninvitedWorld|0")
                    Sleep(1500)
                end
            elseif VENDING.state == 5 then -- Dropping item
                logMessage("Vending: Dropping " .. VENDING.buycount .. " of item " .. VENDING.itemid)
                local pktDrop = "action|dialog_return\n" ..
                                "dialog_name|drop_item\n" ..
                                "itemID|"..VENDING.itemid.."|\n" ..
                                "count|"..VENDING.buycount
                SendPacket(2, pktDrop)
                VENDING.state = 0 -- Reset for next cycle
                Sleep(500) -- Short delay after sending packet
            end
        end

        -- BOOTH
        if Booth.running then
            SendPacket(2, "action|dialog_return\ndialog_name|carnival_booth\ntilex|65|\ntiley|53|\nbuttonClicked|buy_112")
            Sleep(Booth.delay)
        end

        -- MIRRORMAZE State Machine
        -- fungsi cek player lain
local function IsOtherPlayerNearby()
    local me = GetLocal()
    if not me then return false end
    for _, p in pairs(GetPlayerList()) do
        if p.netid ~= me.netid then
            return true, p.name
        end
    end
    return false, nil
end

-- init cycle counter
MIRRORMAZE.count = 0

-- mirrormaze loop
RunThread(function()
    while true do
        if MIRRORMAZE.running then
            -- cek dulu ada player lain ga
            local found, pname = IsOtherPlayerNearby()
            if found then
                logMessage("`4Mirrormaze: Player lain terdeteksi ("..pname.."), auto-leave world!")
                SendPacket(3, "action|quit_to_exit")
                MIRRORMAZE.running = false
                goto continue_loop
            end

            local me = GetLocal()
            if not me then Sleep(50); goto continue_loop end
            local px = math.floor(me.pos.x / 32)
            local py = math.floor(me.pos.y / 32)

            if MIRRORMAZE.state == 0 then -- Step 1: ke pintu
                FindPath(MIRRORMAZE.doorX, MIRRORMAZE.doorY, 100)
                MIRRORMAZE.state = 1
                Sleep(150)

            elseif MIRRORMAZE.state == 1 then -- Step 2: masuk pintu
                if px == MIRRORMAZE.doorX and py == MIRRORMAZE.doorY then
                    SendPacketRaw(false, {
                        type  = 7,
                        value = 18,
                        px    = MIRRORMAZE.doorX,
                        py    = MIRRORMAZE.doorY
                    })
                    MIRRORMAZE.state = 2
                    Sleep(300)
                else
                    FindPath(MIRRORMAZE.doorX, MIRRORMAZE.doorY, 100)
                    Sleep(100)
                end

            elseif MIRRORMAZE.state == 2 then -- Step 3: ke target
                FindPath(MIRRORMAZE.targetX, MIRRORMAZE.targetY, 100)
                if px == MIRRORMAZE.targetX and py == MIRRORMAZE.targetY then
                    MIRRORMAZE.state = 3
                end
                Sleep(100)

            elseif MIRRORMAZE.state == 3 then -- Step 4: sampai target, reset
                MIRRORMAZE.count = (MIRRORMAZE.count or 0) + 1
                logMessage("`2Mirrormaze cycle selesai ke-"..MIRRORMAZE.count)
                MIRRORMAZE.state = 0

                if MIRRORMAZE.count >= 100 then
                    logMessage("`eMirrormaze: Sudah 100x, istirahat 5 detik dulu...")
                    Sleep(5000)
                    MIRRORMAZE.count = 0
                else
                    Sleep(200)
                end
            end
        end
        ::continue_loop::
        Sleep(5)
    end
end)
        -- SHOP
        if Shop.running then
            SendPacket(2, "action|buy\nitem|"..Shop.itemid)
            Sleep(Shop.delay)
        end

        -- UT
        if UT.running then
            SendPacket(2, "action|dialog_return\ndialog_name|itemremovedfromsucker\ntilex|"..UT.tilex.."|\ntiley|"..UT.tiley.."|\nitemtoremove|"..UT.removeItem)
            Sleep(UT.delay)
            SendPacket(2, "action|dialog_return\ndialog_name|drop_item\nitemID|"..UT.dropItem.."|\ncount|"..UT.dropCount)
            Sleep(UT.delay)
        end

        -- PNB State Machine (Non-blocking)
        if PNB.running then
            local me = GetLocal()
            if not me then Sleep(50); goto continue_loop end
            local px = math.floor(me.pos.x / 32)
            local py = math.floor(me.pos.y / 32)

            if PNB.state == 0 then -- Initial state, start placing
                PNB.currentBlock = 1
                PNB.state = 1
                logMessage("PNB: Starting to place blocks.")
            elseif PNB.state == 1 then -- Placing blocks
                if PNB.currentBlock <= PNB.maxBlocks then
                    SendPacketRaw(false, {type=3,int_data=PNB.itemid,px=px+PNB.currentBlock,py=py,value=PNB.itemid})
                    PNB.currentBlock = PNB.currentBlock + 1
                    Sleep(PNB.delay)
                else
                    PNB.currentBlock = 1 -- Reset for breaking
                    PNB.state = 2
                    logMessage("PNB: Finished placing. Starting to break blocks.")
                end
            elseif PNB.state == 2 then -- Breaking blocks
                if PNB.currentBlock <= PNB.maxBlocks then
                    SendPacketRaw(false, {type=3,int_data=18,px=px+PNB.currentBlock,py=py,value=18}) -- 18 is punch ID
                    PNB.currentBlock = PNB.currentBlock + 1
                    Sleep(PNB.delay)
                else
                    PNB.state = 0 -- Reset for next cycle
                    logMessage("PNB: Finished breaking. Cycle complete.")
                    Sleep(500) -- Short break before next cycle
                end
            end
        end

        -- ADDVEND
        if ADDVEND.running then
            local pkt = "action|dialog_return\n" ..
                        "dialog_name|vending\n" ..
                        "tilex|"..ADDVEND.tilex.."|\n" ..
                        "tiley|"..ADDVEND.tiley.."|\n" ..
                        "buttonClicked|addstock\n" ..
                        "setprice|"..ADDVEND.price.."\n" ..
                        "chk_perlock|"..ADDVEND.perlock.."\n" ..
                        "chk_peritem|"..ADDVEND.peritem
            SendPacket(2, pkt)
            Sleep(ADDVEND.delay)
        end

        -- PLANT (Optimized for less FindPath calls and less logging)
        if PLANT.running then
            if currentTime - PLANT.lastPlantTime >= PLANT.plantDelay then
                local me = GetLocal()
                if not me then Sleep(50); goto continue_loop end
                local currentTileX = math.floor(me.pos.x / 32)
                local currentTileY = math.floor(me.pos.y / 32)

                -- Check if current position is within the planting area, if not, pathfind to start
                if not (currentTileX >= PLANT.X_MIN and currentTileX <= PLANT.X_MAX and
                        currentTileY >= PLANT.Y_MIN and currentTileY <= PLANT.Y_MAX) then
                    logMessage("Plant: Moving to start of planting area.")
                    FindPath(PLANT.X_MIN, PLANT.Y_MIN)
                    Sleep(1000) -- Give time to pathfind
                    PLANT.lastPlantTime = currentTime
                    goto continue_loop
                end

                -- Check for seeds
                if GetItemCount(PLANT.seedid) == 0 then
                    logMessage("Plant: No seeds, taking more from (" .. PLANT.TakeSeed_X .. "," .. PLANT.TakeSeed_Y .. ")")
                    FindPath(PLANT.TakeSeed_X, PLANT.TakeSeed_Y)
                    Sleep(500) -- Give time to pathfind and pick up
                    PLANT.lastPlantTime = currentTime
                    goto continue_loop
                end

                local tile = GetTile(PLANT.currentX, PLANT.currentY)
                if tile and tile.fg == 0 then -- Only plant if foreground is empty
                    -- Only pathfind if player is not near the target tile
                    if math.abs(currentTileX - PLANT.currentX) > 2 or math.abs(currentTileY - PLANT.currentY) > 2 then
                        FindPath(PLANT.currentX, PLANT.currentY)
                        Sleep(100) -- Short sleep after pathfinding
                    end
                    plant_pnp(PLANT.currentX, PLANT.currentY, PLANT.seedid)
                    if (PLANT.currentX + PLANT.currentY) % PLANT.logInterval == 0 then
                        logMessage("Plant: Planted at (" .. PLANT.currentX .. "," .. PLANT.currentY .. ")")
                    end
                end

                -- Move to next tile
                if PLANT.currentY % 2 == 0 then -- Even row, move right
                    PLANT.currentX = PLANT.currentX + 1
                    if PLANT.currentX > PLANT.X_MAX then
                        PLANT.currentX = PLANT.X_MAX -- Stay at max for next row's start
                        PLANT.currentY = PLANT.currentY + 1
                    end
                else -- Odd row, move left
                    PLANT.currentX = PLANT.currentX - 1
                    if PLANT.currentX < PLANT.X_MIN then
                        PLANT.currentX = PLANT.X_MIN -- Stay at min for next row's start
                        PLANT.currentY = PLANT.currentY + 1
                    end
                end

                if PLANT.currentY > PLANT.Y_MAX then
                    logMessage("Plant: Finished one full cycle of planting. Resetting.")
                    PLANT.currentX = PLANT.X_MIN
                    PLANT.currentY = PLANT.Y_MIN
                    -- Consider adding a longer sleep here or stopping if only one cycle is desired
                end
                PLANT.lastPlantTime = currentTime
            end
        end

        ::continue_loop::
        Sleep(5) -- Global sleep to prevent busy-waiting and yield CPU
    end
end)

-- ===================== DIALOG =====================
local function ShowSVMSDialog()
    local dialog = [[
set_default_color|`o
add_label_with_icon|big|`cSVMS HELPER! `2< v1.2 >|left|32|
add_label_with_icon|small|`cServer : `9GTFY!|right|6336|
add_spacer|small|
add_image_button|banner|game/gtfy_carnival.rttex|bannerlayout||
add_spacer|small|
add_separator|

add_label_with_icon|small|`cSVMS New Updates!|left|6018|
add_smalltext|`wSeptember 04-05, 2025:|left|
add_smalltext|`2>>  Optimized core loops for better performance and lower FPS impact.|left|
add_smalltext|`2>>  Improved state management for Vending, Mirrormaze, PNB, and Plant features.|left|
add_smalltext|`2>>  Add disconnect handler.|left|
add_smalltext|`2>>  Reduced excessive logging for Plant feature.|left|
add_smalltext|`2>>  More robust handling of player position and world changes.|left|
add_smalltext|`2>>  Bug fixes & performance improvements|left|
add_spacer|small|
add_separator|

add_label_with_icon|small|`eAutomation Features|left|3682|
add_smalltext|`2/booth `7-> Auto Buy Gems from Booth|left|
add_smalltext|`2/mirrormaze `7-> Auto Mirrormaze Solving|left|
add_smalltext|`2/mirrormaze door <x> <y> `7-> Set door coordinate|left|
add_smalltext|`2/mirrormaze target <x> <y> `7-> Set target coordinate|left|
add_smalltext|`2/shop `7-> Auto Buy from Store|left|
add_smalltext|`2/vending `7-> Auto Vending Menu|left|
add_smalltext|`2/vending start|stop `7-> Start/Stop vending cycle|left|
add_smalltext|`2/venditem <id> <count> `7-> Set item & amount|left|
add_smalltext|`2/vendxy <x> <y> `7-> Set vending pos|left|
add_smalltext|`2/dropxy <x> <y> `7-> Set drop pos|left|
add_smalltext|`2/vendworld <shop> <drop> `7-> Set worlds|left|
add_smalltext|`2/addvend `7-> Auto Add Stock|left|
add_smalltext|`2/addvendxy <x> <y> `7-> Set vending pos|left|
add_smalltext|`2/ut `7-> Auto Retrieve UT + drop|left|
add_smalltext|`2/ut xy <x> <y> `7-> Set ut/gaia pos|left|
add_smalltext|`2/ut item <removeItems> <itemID> <dropItems>`7-> Set Removing Count itemID, Dropping Count|left|
add_smalltext|`2/pnb `4(beta) `7-> Auto Place & Break blocks|left|
add_smalltext|`2/plant start|stop `7-> Start/Stop plant cycle|left|
add_smalltext|`2/plant id < Seed ID > `7-> Set Seed ID|left|
add_smalltext|`2/plant x < from x > < to x > `7-> Set x to x world|left|
add_smalltext|`2/plant y < from y > < to y > `7-> Set y to y world|left|
add_spacer|small|
add_separator|

add_label_with_icon|small|`9Lock Helper|left|1796|
add_smalltext|`2/dwl <amount> `7-> Drop WLs|left|
add_smalltext|`2/ddl <amount> `7-> Drop DLs|left|
add_smalltext|`2/dbgl <amount> `7-> Drop BGLs|left|
add_smalltext|`2/deposit <amount> `7-> Deposit BGLs to bank|left|
add_smalltext|`2/wd <amount> `7-> Withdraw BGLs|left|
add_spacer|small|
add_separator|

add_label_with_icon|small|`eExtra Tools|left|9474|
add_smalltext|`2/donate <amount> `7-> Support the developer!|left|
add_smalltext|`2/helpsv `7-> Show this help menu|left|
add_spacer|small|
add_separator|
add_image_button|svms_dc|interface/gtps/discord.rttex|3imageslayout|https://discord.gg/gePbgrZX|Do you want to join our `cDISCORD SERVER``?|
add_button_with_icon||END_LIST|noflags|0||
add_spacer|small|
add_label_with_icon|small|`wPowered By: `e@Seventyn|left|3732|
add_label_with_icon|small|`wJoin Our Discord Server For More Information!|left|28|
add_spacer|small|
end_dialog|gazette||OK|
add_quick_exit
]]
    SendVariantList({[0] = "OnDialogRequest", [1] = dialog})
end

AddHook("OnSendPacket", "SVMS_Commands", function(type, packet)
    if type ~= 2 then return end

    local text = packet:match("text|(.+)")
    if not text then return end

    local args = {}
    for w in text:gmatch("%S+") do table.insert(args, w) end
    local cmd = args[1] or ""
    local num = args[2] or ""

    ---------------- HELP MENU ----------------
    if cmd == "/helpsv" then
        ShowSVMSDialog()
        return true
    end

    ---------------- CARNIVAL ----------------
    if cmd == "/booth" then
        if args[2] then
            local delay = tonumber(args[2])
            if delay and delay >= 0 then -- Ensure delay is non-negative
                Booth.delay = delay
                logMessage("Booth delay updated -> "..delay)
            else
                logMessage("Usage: /booth <delay> (delay must be a non-negative number)")
            end
        else
            Booth.running = not Booth.running
            logMessage(Booth.running and "`2Auto Buy Gems In Booth Started"
                                       or  "`4Auto Buy Gems In Booth Stopped")
        end
        return true
    end

    if cmd == "/mirrormaze" then
        if args[2] == "start" then
            MIRRORMAZE.running = true
            MIRRORMAZE.state = 0 -- Reset state
            logMessage("Mirror Maze Started")
        elseif args[2] == "stop" then
            MIRRORMAZE.running = false
            logMessage("Mirror Maze Stopped")
        elseif args[2] == "door" and args[3] and args[4] then
            MIRRORMAZE.doorX = tonumber(args[3])
            MIRRORMAZE.doorY = tonumber(args[4])
            logMessage("Door updated -> ("..MIRRORMAZE.doorX..","..MIRRORMAZE.doorY..")")
        elseif args[2] == "target" and args[3] and args[4] then
            MIRRORMAZE.targetX = tonumber(args[3])
            MIRRORMAZE.targetY = tonumber(args[4])
            logMessage("Target updated -> ("..MIRRORMAZE.targetX..","..MIRRORMAZE.targetY..")")
        else
            logMessage("Usage: /mirrormaze start | stop | door <x> <y> | target <x> <y>")
        end
        return true
    end

    ---------------- SHOP ----------------
    if cmd == "/shop" then
        if args[2] then
            local item = tonumber(args[2])
            if item and item >= 0 then -- Ensure item ID is non-negative
                Shop.itemid = item
                logMessage("Shop Item ID updated -> "..item)
            else
                logMessage("Usage: /shop <itemid> (itemid must be a non-negative number)")
            end
        else
            Shop.running = not Shop.running
            logMessage(Shop.running and "`2Auto Buy In Store Started"
                                      or  "`4Auto Buy In Store Stopped")
        end
        return true
    end

    ---------------- UT ----------------
    if cmd:lower() == "/ut" then
        if args[2] == "xy" and args[3] and args[4] then
            UT.tilex = tonumber(args[3]) or UT.tilex
            UT.tiley = tonumber(args[4]) or UT.tiley
            logMessage("UT Position updated -> ("..UT.tilex..","..UT.tiley..")")
        elseif args[2] == "item" and args[3] and args[4] and args[5] then
            UT.removeItem = tonumber(args[3]) or UT.removeItem
            UT.dropItem   = tonumber(args[4]) or UT.dropItem
            UT.dropCount  = tonumber(args[5]) or UT.dropCount
            logMessage("UT Items updated -> Remove:"..UT.removeItem..
                         " Drop:"..UT.dropItem.." Count:"..UT.dropCount)
        else
            UT.running = not UT.running
            logMessage(UT.running and "`2Auto Ret UT Started"
                                     or  "`4Auto Ret UT Stopped")
        end
        return true
    end

    ---------------- PNB ----------------
    if cmd == "/pnb" then
        PNB.running = not PNB.running
        PNB.state = 0 -- Reset state
        logMessage(PNB.running and "`2PNB Started"
                                or  "`4PNB Stopped")
        return true
    end

    ---------------- PLANT ----------------
    if cmd == "/plant" then
        if args[2] == "start" then
            PLANT.running = true
            PLANT.currentX = PLANT.X_MIN -- Reset plant position
            PLANT.currentY = PLANT.Y_MIN
            logMessage("Auto Plant Started!")
        elseif args[2] == "stop" then
            PLANT.running = false
            logMessage("Auto Plant Stopped!")
        elseif args[2] == "x" and args[3] and args[4] then
            PLANT.X_MIN = tonumber(args[3])
            PLANT.X_MAX = tonumber(args[4])
            logMessage("Updated X range → "..PLANT.X_MIN.." - "..PLANT.X_MAX)
        elseif args[2] == "y" and args[3] and args[4] then
            PLANT.Y_MIN = tonumber(args[3])
            PLANT.Y_MAX = tonumber(args[4])
            logMessage("Updated Y range → "..PLANT.Y_MIN.." - "..PLANT.Y_MAX)
        elseif args[2] == "id" and args[3] then
            PLANT.seedid = tonumber(args[3])
            logMessage("Updated Tree/Seed ID → "..PLANT.seedid)
        else
            logMessage("Usage: /plant start | stop | x <min> <max> | y <min> <max> | id <itemID>")
        end
        return true
    end

    ---------------- LOCK COMMANDS ----------------
    local amount = tonumber(num) or 1
    if cmd == "/dbgl" then
        SendPacket(2, "action|dialog_return\ndialog_name|drop_item\nitemID|7188|\ncount|"..amount)
        logMessage("Dropped "..amount.." BGL")
        return true
    end
    if cmd == "/ddl" then
        SendPacket(2, "action|dialog_return\ndialog_name|drop_item\nitemID|1796|\ncount|"..amount)
        logMessage("Dropped "..amount.." DL")
        return true
    end
    if cmd == "/dwl" then
        SendPacket(2, "action|dialog_return\ndialog_name|drop_item\nitemID|242|\ncount|"..amount)
        logMessage("Dropped "..amount.." WL")
        return true
    end
    if cmd == "/deposit" then
        local pkt = "action|dialog_return\n" ..
                    "dialog_name|my_bank_account\n" ..
                    "buttonClicked|depo_true\n" ..
                    "bgl_|"..amount
        SendPacket(2, pkt)
        logMessage("Deposited "..amount.." BGL")
        return true
    end
    if cmd == "/wd" then
        local pkt = "action|dialog_return\n" ..
                    "dialog_name|my_bank_account\n" ..
                    "buttonClicked|wd_true\n" ..
                    "wd_|"..amount
        SendPacket(2, pkt)
        logMessage("Withdrew "..amount.." BGL")
        return true
    end
    if cmd == "/donate" then
        RunThread(function()
            SendPacket(3, "action|join_request\nname|svms\ninvitedWorld|0")
            Sleep(1500)
            local pkt = "action|dialog_return\n" ..
                        "dialog_name|give_item\n" ..
                        "itemID|7188|\n" ..
                        "tilex|49|\n" ..
                        "tiley|35|\n" ..
                        "buttonClicked|give\n" ..
                        "count|"..amount.."|\n" ..
                        "sign_text|"
            SendPacket(2, pkt)
            logMessage("Thanks For The Support!")
        end)
        return true
    end

    ---------------- VENDING ----------------
    if cmd == "/vending" then
        if num == "start" then
            VENDING.running = true
            VENDING.state = 0 -- Reset state
            logMessage("Auto Vending-Drop Started")
        elseif num == "stop" then
            VENDING.running = false
            logMessage("Auto Vending-Drop Stopped")
        else
            logMessage("Automation Vending Menu:")
            logMessage("/vending start | stop")
            logMessage("/venditem <itemid> <jumlah>")
            logMessage("/vendxy <tileX> <tileY>")
            logMessage("/dropxy <tileX> <tileY>")
            logMessage("/vendworld <vendWorld> <dropWorld>")
            logMessage("/addvend start | stop")
            logMessage("/addvendxy <tileX> <tileY>")
        end
        return true
    end

    if cmd == "/venditem" then
        local id, count = tonumber(args[2]), tonumber(args[3])
        if id and count and id >= 0 and count >= 0 then
            VENDING.itemid = id
            VENDING.buycount = count
            logMessage("Vending Item Updated -> ItemID: "..id.." Count: "..count)
        else
            logMessage("Usage: /venditem <itemid> <jumlah> (itemid and jumlah must be non-negative numbers)")
        end
        return true
    end

    if cmd == "/vendxy" then
        local x, y = tonumber(args[2]), tonumber(args[3])
        if x and y then
            VENDING.tilex, VENDING.tiley = x, y
            logMessage("Vending position updated -> ("..x..","..y..")")
        else
            logMessage("Usage: /vendxy <tileX> <tileY>")
        end
        return true
    end

    if cmd == "/dropxy" then
        local x, y = tonumber(args[2]), tonumber(args[3])
        if x and y then
            VENDING.dropx, VENDING.dropy = x, y
            logMessage("Drop position updated -> ("..x..","..y..")")
        else
            logMessage("Usage: /dropxy <tileX> <tileY>")
        end
        return true
    end

    if cmd == "/vendworld" then
        local shop, drop = args[2], args[3]
        if shop and drop then
            VENDING.shopWorld, VENDING.dropWorld = shop, drop
            logMessage("Vending Worlds Updated -> Shop: "..shop.." Drop: "..drop)
        else
            logMessage("Usage: /vendworld <vendWorld> <dropWorld>")
        end
        return true
    end

    ---------------- ADDVEND ----------------
    if cmd == "/addvend" then
        if num == "start" then
            ADDVEND.running = true
            logMessage("Auto AddVending Started")
        elseif num == "stop" then
            ADDVEND.running = false
            logMessage("Auto AddVending Stopped")
        else
            logMessage("Usage: /addvend start | stop")
        end
        return true
    end

    if cmd == "/addvendxy" then
        local x, y = tonumber(args[2]), tonumber(args[3])
        if x and y then
            ADDVEND.tilex, ADDVEND.tiley = x, y
            logMessage("AddVend position updated -> ("..x..","..y..")")
        else
            logMessage("Usage: /addvendxy <tileX> <tileY>")
        end
        return true
    end
end)

local lastWorld = "SVMS"
AddHook("OnSendPacket", "saveWorld", function(type, packet)
    if type == 3 then
        local world = packet:match("name|(%S+)")
        if world then
            lastWorld = world
            LogToConsole("`c[ SVMS ] `eSaved last world -> "..lastWorld)
        end
    end
end)

RunThread(function()
    while true do
        if GetWorld().name == "" then
            LogToConsole("`c[ SVMS ] `4Disconnected, reconnecting...")
            Sleep(2000)
            SendPacket(3, "action|join_request\nname|"..lastWorld.."\ninvitedWorld|0")
        end
        Sleep(1000)
    end
end)
